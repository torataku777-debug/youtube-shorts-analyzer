{
  "version": 3,
  "sources": [],
  "sections": [
    {"offset": {"line": 46, "column": 0}, "map": {"version":3,"sources":["file:///Users/toratanitaku/Desktop/youtube-shorts-analyzer/lib/supabase.ts"],"sourcesContent":["\nimport { createClient } from '@supabase/supabase-js'\n\nconst supabaseUrl = process.env.NEXT_PUBLIC_SUPABASE_URL!\nconst supabaseAnonKey = process.env.NEXT_PUBLIC_SUPABASE_ANON_KEY!\n\nexport const supabase = createClient(supabaseUrl, supabaseAnonKey)\n"],"names":[],"mappings":";;;;AACA;;AAEA,MAAM;AACN,MAAM;AAEC,MAAM,WAAW,IAAA,gMAAY,EAAC,aAAa"}},
    {"offset": {"line": 149, "column": 0}, "map": {"version":3,"sources":["file:///Users/toratanitaku/Desktop/youtube-shorts-analyzer/lib/youtube-server.ts"],"sourcesContent":["\nimport { google } from 'googleapis';\n\nconst youtube = google.youtube('v3');\nconst YOUTUBE_API_KEY = process.env.YOUTUBE_API_KEY;\n\nif (!YOUTUBE_API_KEY) {\n    throw new Error('YOUTUBE_API_KEY is not defined');\n}\n\nfunction parseDuration(duration: string): number {\n    const match = duration.match(/PT(\\d+H)?(\\d+M)?(\\d+S)?/);\n    if (!match) return 0;\n    const hours = (parseInt(match[1] || '0')) || 0;\n    const minutes = (parseInt(match[2] || '0')) || 0;\n    const seconds = (parseInt(match[3] || '0')) || 0;\n    return hours * 3600 + minutes * 60 + seconds;\n}\n\nfunction containsJapanese(text: string): boolean {\n    return /[\\u3000-\\u303f\\u3040-\\u309f\\u30a0-\\u30ff\\uff00-\\uff9f\\u4e00-\\u9faf\\u3400-\\u4dbf]/.test(text);\n}\n\n// Kids Content Blacklist\nconst KIDS_KEYWORDS = [\n    'CoComelon', 'BabyBus', 'Bebefinn', 'Little Angel', 'Super Simple Songs',\n    'Pinkfong', 'ChuChu TV', 'LooLoo Kids', 'Blippi', 'Vlad and Niki',\n    'Diana and Roma', 'Like Nastya', 'Maria Clara & JP', 'Kids', 'Nursery Rhymes',\n    'あかちゃん', 'キッズ', '子供向け', '童謡'\n];\n\nfunction isKidsContent(item: any): boolean {\n    // 1. YouTube API Flag\n    if (item.status?.madeForKids) return true;\n\n    // 2. Category 1 (Film & Animation) - very high correlation with kids content on Shorts\n    // But strictly, we might not want to ban ALL animation. \n    // User asked to exclude Category 1 previously, so we keep that logic as \"Kids-like\" for now?\n    // Actually, user said \"Exclude Category 1 OR global kids channels\".\n    if (item.snippet?.categoryId === '1') return true;\n\n    // 3. Keyword/Channel Check\n    const title = (item.snippet?.title || '').toLowerCase();\n    const channel = (item.snippet?.channelTitle || '').toLowerCase();\n\n    return KIDS_KEYWORDS.some(k => title.includes(k.toLowerCase()) || channel.includes(k.toLowerCase()));\n}\n\ninterface FetchOptions {\n    regionCode: string;\n    relevanceLanguage: string;\n    keywords: string[];\n}\n\nexport async function fetchTrendingShorts(options: FetchOptions, targetCount = 20) {\n    try {\n        let shorts: any[] = [];\n\n        // Strategy 1: Real Trends (mostPopular)\n        console.log(`[${options.regionCode}] Strategy 1: Scanning Most Popular...`);\n        for (let i = 0; i < 3; i++) {\n            const response = await youtube.videos.list({\n                key: YOUTUBE_API_KEY,\n                part: ['snippet', 'statistics', 'contentDetails', 'status'], // Added 'status'\n                chart: 'mostPopular',\n                regionCode: options.regionCode,\n                maxResults: 50\n            });\n            const items = response.data.items || [];\n            const pageShorts = items.filter(item => {\n                const d = parseDuration(item.contentDetails?.duration || '');\n                return d > 0 && d <= 61;\n            });\n            shorts = [...shorts, ...pageShorts];\n            if (!response.data.nextPageToken) break;\n        }\n        console.log(`[${options.regionCode}] Trends strategy found: ${shorts.length}`);\n\n        // Strategy 2: Search Backfill\n        if (shorts.length < targetCount) {\n            console.log(`[${options.regionCode}] Strategy 2: Searching keywords...`);\n\n            const queries = [\n                `${options.keywords.join('|')} #Shorts`,\n                '#Shorts'\n            ];\n\n            for (const query of queries) {\n                if (shorts.length >= targetCount) break;\n\n                const response = await youtube.search.list({\n                    key: YOUTUBE_API_KEY,\n                    part: ['snippet'],\n                    q: query,\n                    type: ['video'],\n                    videoDuration: 'short',\n                    regionCode: options.regionCode,\n                    relevanceLanguage: options.relevanceLanguage,\n                    order: 'viewCount',\n                    maxResults: 50\n                });\n\n                const searchItems = response.data.items || [];\n                const videoIds = searchItems.map(i => i.id?.videoId).filter(Boolean) as string[];\n\n                if (videoIds.length > 0) {\n                    const details = await youtube.videos.list({\n                        key: YOUTUBE_API_KEY,\n                        part: ['snippet', 'statistics', 'contentDetails', 'status'], // Added 'status'\n                        id: videoIds\n                    });\n\n                    const items = details.data.items || [];\n                    const filtered = items.filter(item => {\n                        const d = parseDuration(item.contentDetails?.duration || '');\n                        if (d <= 0 || d > 61) return false;\n\n                        // Language Filter\n                        if (options.regionCode === 'JP') {\n                            const hasJP = containsJapanese(item.snippet?.title || '') || containsJapanese(item.snippet?.description || '');\n                            if (!hasJP) return false;\n                        }\n\n                        return true;\n                    });\n\n                    shorts = [...shorts, ...filtered];\n                }\n            }\n        }\n\n        // Dedup & Determine is_kids\n        const uniqueMap = new Map();\n        shorts.forEach(s => {\n            if (!uniqueMap.has(s.id)) {\n                // Attach our computed is_kids flag to the object for easy access later\n                s.is_kids_computed = isKidsContent(s);\n                uniqueMap.set(s.id, s);\n            }\n        });\n\n        const finalShorts = Array.from(uniqueMap.values());\n        console.log(`[${options.regionCode}] Final count: ${finalShorts.length}`);\n        return finalShorts;\n\n    } catch (error) {\n        console.error('Error fetching trending shorts:', error);\n        return [];\n    }\n}\n\nexport async function fetchChannelStats(channelIds: string[]) {\n    try {\n        const response = await youtube.channels.list({\n            key: YOUTUBE_API_KEY,\n            part: ['snippet', 'statistics'],\n            id: channelIds,\n        });\n        return response.data.items || [];\n    } catch (error) {\n        console.error('Error fetching channel stats:', error);\n        return [];\n    }\n}\n"],"names":[],"mappings":"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"}},
    {"offset": {"line": 330, "column": 0}, "map": {"version":3,"sources":["file:///Users/toratanitaku/Desktop/youtube-shorts-analyzer/lib/keyword-extractor.ts"],"sourcesContent":["export interface KeywordStats {\n    keyword: string;\n    count: number;\n}\n\nconst STOP_WORDS = new Set([\n    // English Stop Words\n    'the', 'be', 'to', 'of', 'and', 'a', 'in', 'that', 'have', 'i', 'it', 'for', 'not', 'on', 'with', 'he', 'as', 'you', 'do', 'at',\n    'this', 'but', 'his', 'by', 'from', 'they', 'we', 'say', 'her', 'she', 'or', 'an', 'will', 'my', 'one', 'all', 'would', 'there',\n    'their', 'what', 'so', 'up', 'out', 'if', 'about', 'who', 'get', 'which', 'go', 'me', 'when', 'make', 'can', 'like', 'time', 'no',\n    'just', 'him', 'know', 'take', 'people', 'into', 'year', 'your', 'good', 'some', 'could', 'them', 'see', 'other', 'than', 'then',\n    'now', 'look', 'only', 'come', 'its', 'over', 'think', 'also', 'back', 'after', 'use', 'two', 'how', 'our', 'work', 'first', 'well',\n    'way', 'even', 'new', 'want', 'because', 'any', 'these', 'give', 'day', 'most', 'us', 'youtube', 'video', 'shorts', 'short', 'channel',\n    // Japanese Stop Words (common particles and generic terms)\n    'の', 'に', 'は', 'を', 'た', 'が', 'で', 'て', 'と', 'し', 'れ', 'さ', 'ある', 'いる', 'も', 'する', 'から', 'な', 'こと', 'として',\n    'い', 'や', 'れる', 'など', 'なっ', 'ない', 'この', 'ため', 'その', 'あっ', 'よう', 'また', 'もの', 'という', 'あり', 'まで',\n    'られ', 'なる', 'へ', 'か', 'だ', 'これ', 'によって', 'により', 'おり', 'より', 'による', 'ず', 'なり', 'られる', 'において',\n    'ば', 'なかっ', 'なく', 'しかし', 'について', 'せ', 'だっ', 'その後', 'できる', 'そこ', '動画', 'ショート', '登録', 'チャンネル'\n]);\n\nexport function extractTrendingKeywords(videos: { title: string, description: string }[]): KeywordStats[] {\n    const wordCounts = new Map<string, number>();\n\n    videos.forEach(video => {\n        // Combine title and description\n        const text = (video.title + \" \" + (video.description || \"\")).toLowerCase();\n\n        // Extract hashtags explicitly\n        const hashtags = text.match(/#[^\\s#]+/g) || [];\n        hashtags.forEach(tag => {\n            const cleanTag = tag.replace('#', '');\n            if (cleanTag.length > 1) {\n                wordCounts.set(cleanTag, (wordCounts.get(cleanTag) || 0) + 1);\n            }\n        });\n\n        // Tokenize text for words (simple space separation for EN, could use tokenizer for JP but simple regex works for major keywords)\n        // Removing special chars\n        const cleanText = text.replace(/#[^\\s#]+/g, '') // remove hashtags from text stream to avoid double counting\n            .replace(/[!?,.。\"';:()\\[\\]]/g, ' ');\n\n        const words = cleanText.split(/\\s+/);\n\n        words.forEach(word => {\n            if (word.length < 2) return;\n            if (STOP_WORDS.has(word)) return;\n            if (/^\\d+$/.test(word)) return; // skip numbers\n\n            wordCounts.set(word, (wordCounts.get(word) || 0) + 1);\n        });\n    });\n\n    // Convert to array and sort\n    const sortedKeywords = Array.from(wordCounts.entries())\n        .map(([keyword, count]) => ({ keyword, count }))\n        .sort((a, b) => b.count - a.count);\n\n    // Return top 20\n    return sortedKeywords.slice(0, 20);\n}\n"],"names":[],"mappings":";;;;AAKA,MAAM,aAAa,IAAI,IAAI;IACvB,qBAAqB;IACrB;IAAO;IAAM;IAAM;IAAM;IAAO;IAAK;IAAM;IAAQ;IAAQ;IAAK;IAAM;IAAO;IAAO;IAAM;IAAQ;IAAM;IAAM;IAAO;IAAM;IAC3H;IAAQ;IAAO;IAAO;IAAM;IAAQ;IAAQ;IAAM;IAAO;IAAO;IAAO;IAAM;IAAM;IAAQ;IAAM;IAAO;IAAO;IAAS;IACxH;IAAS;IAAQ;IAAM;IAAM;IAAO;IAAM;IAAS;IAAO;IAAO;IAAS;IAAM;IAAM;IAAQ;IAAQ;IAAO;IAAQ;IAAQ;IAC7H;IAAQ;IAAO;IAAQ;IAAQ;IAAU;IAAQ;IAAQ;IAAQ;IAAQ;IAAQ;IAAS;IAAQ;IAAO;IAAS;IAAQ;IAC1H;IAAO;IAAQ;IAAQ;IAAQ;IAAO;IAAQ;IAAS;IAAQ;IAAQ;IAAS;IAAO;IAAO;IAAO;IAAO;IAAQ;IAAS;IAC7H;IAAO;IAAQ;IAAO;IAAQ;IAAW;IAAO;IAAS;IAAQ;IAAO;IAAQ;IAAM;IAAW;IAAS;IAAU;IAAS;IAC7H,2DAA2D;IAC3D;IAAK;IAAK;IAAK;IAAK;IAAK;IAAK;IAAK;IAAK;IAAK;IAAK;IAAK;IAAK;IAAM;IAAM;IAAK;IAAM;IAAM;IAAK;IAAM;IACpG;IAAK;IAAK;IAAM;IAAM;IAAM;IAAM;IAAM;IAAM;IAAM;IAAM;IAAM;IAAM;IAAM;IAAO;IAAM;IACzF;IAAM;IAAM;IAAK;IAAK;IAAK;IAAM;IAAQ;IAAO;IAAM;IAAM;IAAO;IAAK;IAAM;IAAO;IACrF;IAAK;IAAO;IAAM;IAAO;IAAQ;IAAK;IAAM;IAAO;IAAO;IAAM;IAAM;IAAQ;IAAM;CACvF;AAEM,SAAS,wBAAwB,MAAgD;IACpF,MAAM,aAAa,IAAI;IAEvB,OAAO,OAAO,CAAC,CAAA;QACX,gCAAgC;QAChC,MAAM,OAAO,CAAC,MAAM,KAAK,GAAG,MAAM,CAAC,MAAM,WAAW,IAAI,EAAE,CAAC,EAAE,WAAW;QAExE,8BAA8B;QAC9B,MAAM,WAAW,KAAK,KAAK,CAAC,gBAAgB,EAAE;QAC9C,SAAS,OAAO,CAAC,CAAA;YACb,MAAM,WAAW,IAAI,OAAO,CAAC,KAAK;YAClC,IAAI,SAAS,MAAM,GAAG,GAAG;gBACrB,WAAW,GAAG,CAAC,UAAU,CAAC,WAAW,GAAG,CAAC,aAAa,CAAC,IAAI;YAC/D;QACJ;QAEA,iIAAiI;QACjI,yBAAyB;QACzB,MAAM,YAAY,KAAK,OAAO,CAAC,aAAa,IAAI,4DAA4D;SACvG,OAAO,CAAC,sBAAsB;QAEnC,MAAM,QAAQ,UAAU,KAAK,CAAC;QAE9B,MAAM,OAAO,CAAC,CAAA;YACV,IAAI,KAAK,MAAM,GAAG,GAAG;YACrB,IAAI,WAAW,GAAG,CAAC,OAAO;YAC1B,IAAI,QAAQ,IAAI,CAAC,OAAO,QAAQ,eAAe;YAE/C,WAAW,GAAG,CAAC,MAAM,CAAC,WAAW,GAAG,CAAC,SAAS,CAAC,IAAI;QACvD;IACJ;IAEA,4BAA4B;IAC5B,MAAM,iBAAiB,MAAM,IAAI,CAAC,WAAW,OAAO,IAC/C,GAAG,CAAC,CAAC,CAAC,SAAS,MAAM,GAAK,CAAC;YAAE;YAAS;QAAM,CAAC,GAC7C,IAAI,CAAC,CAAC,GAAG,IAAM,EAAE,KAAK,GAAG,EAAE,KAAK;IAErC,gBAAgB;IAChB,OAAO,eAAe,KAAK,CAAC,GAAG;AACnC"}},
    {"offset": {"line": 545, "column": 0}, "map": {"version":3,"sources":["file:///Users/toratanitaku/Desktop/youtube-shorts-analyzer/app/api/ingest/route.ts"],"sourcesContent":["import { NextResponse } from 'next/server';\nimport { supabase } from '@/lib/supabase';\nimport { fetchTrendingShorts, fetchChannelStats } from '@/lib/youtube-server';\nimport { extractTrendingKeywords } from '@/lib/keyword-extractor';\nimport { google } from 'googleapis';\n\nexport const dynamic = 'force-dynamic';\n\nconst youtube = google.youtube('v3');\nconst YOUTUBE_API_KEY = process.env.YOUTUBE_API_KEY;\n\n// Helper to save channels and videos to DB (reusable for both main ingest and deep ingest)\nasync function saveToDatabase(videoStats: any[], regionCode: string) {\n    if (videoStats.length === 0) return 0;\n\n    // Upsert Channels\n    const channelIds = [...new Set(videoStats.map((v: any) => v.snippet.channelId))];\n    const channelStats = await fetchChannelStats(channelIds as string[]);\n\n    const channelsData = channelStats.map((c: any) => ({\n        youtube_id: c.id,\n        title: c.snippet.title,\n        thumbnail_url: c.snippet.thumbnails.default.url,\n        custom_url: c.snippet.customUrl,\n        video_count: parseInt(c.statistics.videoCount || '0'),\n        view_count: parseInt(c.statistics.viewCount || '0'),\n        published_at: c.snippet.publishedAt,\n        country: c.snippet.country || regionCode\n    }));\n\n    await supabase.from('channels').upsert(channelsData, { onConflict: 'youtube_id' });\n\n    // Upsert Videos\n    const { data: storedChannels } = await supabase\n        .from('channels')\n        .select('id, youtube_id')\n        .in('youtube_id', channelIds);\n\n    const channelMap = new Map(storedChannels?.map(c => [c.youtube_id, c.id]));\n\n    const videosData = videoStats.map((v: any) => ({\n        youtube_id: v.id,\n        channel_id: channelMap.get(v.snippet.channelId),\n        title: v.snippet.title,\n        description: v.snippet.description,\n        published_at: v.snippet.publishedAt,\n        thumbnail_url: v.snippet.thumbnails.high?.url || v.snippet.thumbnails.default.url,\n        duration: v.contentDetails.duration,\n        region: regionCode,\n        is_kids: v.is_kids_computed\n    })).filter(v => v.channel_id);\n\n    const { data: storedVideos, error: videoError } = await supabase\n        .from('videos')\n        .upsert(videosData, { onConflict: 'youtube_id' })\n        .select();\n\n    if (videoError) console.error(videoError);\n\n    // Metrics\n    if (storedVideos) {\n        const videoMap = new Map(storedVideos.map((v: any) => [v.youtube_id, v.id]));\n        const metricsData = videoStats.map((v: any) => ({\n            video_id: videoMap.get(v.id),\n            view_count: parseInt(v.statistics.viewCount || '0'),\n            like_count: parseInt(v.statistics.likeCount || '0'),\n            comment_count: parseInt(v.statistics.commentCount || '0'),\n            recorded_at: new Date().toISOString()\n        })).filter(m => m.video_id);\n\n        await supabase.from('daily_metrics').insert(metricsData);\n    }\n\n    return videosData.length;\n}\n\nexport async function GET() {\n    try {\n        console.log('Starting Multi-Region Deep Ingest...');\n\n        const regions = [\n            {\n                code: 'JP',\n                lang: 'ja',\n                keywords: ['切り抜き', 'あるある', '歌ってみた', '解説', '猫', '料理', 'ダンス']\n            },\n            {\n                code: 'US',\n                lang: 'en',\n                keywords: ['funny', 'challenge', 'tutorial', 'gameplay', 'meme', 'lifehack']\n            }\n        ];\n\n        let totalVideos = 0;\n\n        for (const region of regions) {\n            console.log(`Processing Region: ${region.code}`);\n\n            // 1. Initial Ingest (Trends + Manual Keywords)\n            const initialVideos = await fetchTrendingShorts({\n                regionCode: region.code,\n                relevanceLanguage: region.lang,\n                keywords: region.keywords\n            }, 50);\n\n            const savedCount = await saveToDatabase(initialVideos, region.code);\n            totalVideos += savedCount;\n\n            // 2. Keyword Extraction\n            const videosForExtraction = initialVideos.map((v: any) => ({\n                title: v.snippet.title,\n                description: v.snippet.description\n            }));\n            const extractedKeywords = extractTrendingKeywords(videosForExtraction);\n\n            // Save keywords to DB\n            const keywordsToUpsert = extractedKeywords.slice(0, 20).map(k => ({\n                keyword: k.keyword,\n                region: region.code,\n                frequency: k.count\n            }));\n\n            if (keywordsToUpsert.length > 0) {\n                await supabase\n                    .from('trending_keywords')\n                    .upsert(keywordsToUpsert, { onConflict: 'keyword,region' });\n            }\n\n            // 3. Deep Search (Top 5 Keywords)\n            console.log(`[${region.code}] Starting Deep Search on top keywords...`);\n            const topKeywords = extractedKeywords.slice(0, 5); // Take top 5\n\n            for (const k of topKeywords) {\n                console.log(`[${region.code}] Deep Search: ${k.keyword}`);\n                const deepVideos = await fetchTrendingShorts({\n                    regionCode: region.code,\n                    relevanceLanguage: region.lang,\n                    keywords: [k.keyword] // Recursively search for this new keyword\n                }, 10); // Fetch a small batch per keyword\n\n                const deepSaved = await saveToDatabase(deepVideos, region.code);\n                totalVideos += deepSaved;\n            }\n        }\n\n        return NextResponse.json({ success: true, totalProcessed: totalVideos });\n\n    } catch (error) {\n        console.error('API Error:', error);\n        return NextResponse.json({ error: 'Internal Server Error' }, { status: 500 });\n    }\n}\n"],"names":[],"mappings":";;;;;;AAAA;AACA;AACA;AACA;AACA;;;;;;AAEO,MAAM,UAAU;AAEvB,MAAM,UAAU,+JAAM,CAAC,OAAO,CAAC;AAC/B,MAAM,kBAAkB,QAAQ,GAAG,CAAC,eAAe;AAEnD,2FAA2F;AAC3F,eAAe,eAAe,UAAiB,EAAE,UAAkB;IAC/D,IAAI,WAAW,MAAM,KAAK,GAAG,OAAO;IAEpC,kBAAkB;IAClB,MAAM,aAAa;WAAI,IAAI,IAAI,WAAW,GAAG,CAAC,CAAC,IAAW,EAAE,OAAO,CAAC,SAAS;KAAG;IAChF,MAAM,eAAe,MAAM,IAAA,+IAAiB,EAAC;IAE7C,MAAM,eAAe,aAAa,GAAG,CAAC,CAAC,IAAW,CAAC;YAC/C,YAAY,EAAE,EAAE;YAChB,OAAO,EAAE,OAAO,CAAC,KAAK;YACtB,eAAe,EAAE,OAAO,CAAC,UAAU,CAAC,OAAO,CAAC,GAAG;YAC/C,YAAY,EAAE,OAAO,CAAC,SAAS;YAC/B,aAAa,SAAS,EAAE,UAAU,CAAC,UAAU,IAAI;YACjD,YAAY,SAAS,EAAE,UAAU,CAAC,SAAS,IAAI;YAC/C,cAAc,EAAE,OAAO,CAAC,WAAW;YACnC,SAAS,EAAE,OAAO,CAAC,OAAO,IAAI;QAClC,CAAC;IAED,MAAM,6HAAQ,CAAC,IAAI,CAAC,YAAY,MAAM,CAAC,cAAc;QAAE,YAAY;IAAa;IAEhF,gBAAgB;IAChB,MAAM,EAAE,MAAM,cAAc,EAAE,GAAG,MAAM,6HAAQ,CAC1C,IAAI,CAAC,YACL,MAAM,CAAC,kBACP,EAAE,CAAC,cAAc;IAEtB,MAAM,aAAa,IAAI,IAAI,gBAAgB,IAAI,CAAA,IAAK;YAAC,EAAE,UAAU;YAAE,EAAE,EAAE;SAAC;IAExE,MAAM,aAAa,WAAW,GAAG,CAAC,CAAC,IAAW,CAAC;YAC3C,YAAY,EAAE,EAAE;YAChB,YAAY,WAAW,GAAG,CAAC,EAAE,OAAO,CAAC,SAAS;YAC9C,OAAO,EAAE,OAAO,CAAC,KAAK;YACtB,aAAa,EAAE,OAAO,CAAC,WAAW;YAClC,cAAc,EAAE,OAAO,CAAC,WAAW;YACnC,eAAe,EAAE,OAAO,CAAC,UAAU,CAAC,IAAI,EAAE,OAAO,EAAE,OAAO,CAAC,UAAU,CAAC,OAAO,CAAC,GAAG;YACjF,UAAU,EAAE,cAAc,CAAC,QAAQ;YACnC,QAAQ;YACR,SAAS,EAAE,gBAAgB;QAC/B,CAAC,GAAG,MAAM,CAAC,CAAA,IAAK,EAAE,UAAU;IAE5B,MAAM,EAAE,MAAM,YAAY,EAAE,OAAO,UAAU,EAAE,GAAG,MAAM,6HAAQ,CAC3D,IAAI,CAAC,UACL,MAAM,CAAC,YAAY;QAAE,YAAY;IAAa,GAC9C,MAAM;IAEX,IAAI,YAAY,QAAQ,KAAK,CAAC;IAE9B,UAAU;IACV,IAAI,cAAc;QACd,MAAM,WAAW,IAAI,IAAI,aAAa,GAAG,CAAC,CAAC,IAAW;gBAAC,EAAE,UAAU;gBAAE,EAAE,EAAE;aAAC;QAC1E,MAAM,cAAc,WAAW,GAAG,CAAC,CAAC,IAAW,CAAC;gBAC5C,UAAU,SAAS,GAAG,CAAC,EAAE,EAAE;gBAC3B,YAAY,SAAS,EAAE,UAAU,CAAC,SAAS,IAAI;gBAC/C,YAAY,SAAS,EAAE,UAAU,CAAC,SAAS,IAAI;gBAC/C,eAAe,SAAS,EAAE,UAAU,CAAC,YAAY,IAAI;gBACrD,aAAa,IAAI,OAAO,WAAW;YACvC,CAAC,GAAG,MAAM,CAAC,CAAA,IAAK,EAAE,QAAQ;QAE1B,MAAM,6HAAQ,CAAC,IAAI,CAAC,iBAAiB,MAAM,CAAC;IAChD;IAEA,OAAO,WAAW,MAAM;AAC5B;AAEO,eAAe;IAClB,IAAI;QACA,QAAQ,GAAG,CAAC;QAEZ,MAAM,UAAU;YACZ;gBACI,MAAM;gBACN,MAAM;gBACN,UAAU;oBAAC;oBAAQ;oBAAQ;oBAAS;oBAAM;oBAAK;oBAAM;iBAAM;YAC/D;YACA;gBACI,MAAM;gBACN,MAAM;gBACN,UAAU;oBAAC;oBAAS;oBAAa;oBAAY;oBAAY;oBAAQ;iBAAW;YAChF;SACH;QAED,IAAI,cAAc;QAElB,KAAK,MAAM,UAAU,QAAS;YAC1B,QAAQ,GAAG,CAAC,CAAC,mBAAmB,EAAE,OAAO,IAAI,EAAE;YAE/C,+CAA+C;YAC/C,MAAM,gBAAgB,MAAM,IAAA,iJAAmB,EAAC;gBAC5C,YAAY,OAAO,IAAI;gBACvB,mBAAmB,OAAO,IAAI;gBAC9B,UAAU,OAAO,QAAQ;YAC7B,GAAG;YAEH,MAAM,aAAa,MAAM,eAAe,eAAe,OAAO,IAAI;YAClE,eAAe;YAEf,wBAAwB;YACxB,MAAM,sBAAsB,cAAc,GAAG,CAAC,CAAC,IAAW,CAAC;oBACvD,OAAO,EAAE,OAAO,CAAC,KAAK;oBACtB,aAAa,EAAE,OAAO,CAAC,WAAW;gBACtC,CAAC;YACD,MAAM,oBAAoB,IAAA,wJAAuB,EAAC;YAElD,sBAAsB;YACtB,MAAM,mBAAmB,kBAAkB,KAAK,CAAC,GAAG,IAAI,GAAG,CAAC,CAAA,IAAK,CAAC;oBAC9D,SAAS,EAAE,OAAO;oBAClB,QAAQ,OAAO,IAAI;oBACnB,WAAW,EAAE,KAAK;gBACtB,CAAC;YAED,IAAI,iBAAiB,MAAM,GAAG,GAAG;gBAC7B,MAAM,6HAAQ,CACT,IAAI,CAAC,qBACL,MAAM,CAAC,kBAAkB;oBAAE,YAAY;gBAAiB;YACjE;YAEA,kCAAkC;YAClC,QAAQ,GAAG,CAAC,CAAC,CAAC,EAAE,OAAO,IAAI,CAAC,yCAAyC,CAAC;YACtE,MAAM,cAAc,kBAAkB,KAAK,CAAC,GAAG,IAAI,aAAa;YAEhE,KAAK,MAAM,KAAK,YAAa;gBACzB,QAAQ,GAAG,CAAC,CAAC,CAAC,EAAE,OAAO,IAAI,CAAC,eAAe,EAAE,EAAE,OAAO,EAAE;gBACxD,MAAM,aAAa,MAAM,IAAA,iJAAmB,EAAC;oBACzC,YAAY,OAAO,IAAI;oBACvB,mBAAmB,OAAO,IAAI;oBAC9B,UAAU;wBAAC,EAAE,OAAO;qBAAC,CAAC,0CAA0C;gBACpE,GAAG,KAAK,kCAAkC;gBAE1C,MAAM,YAAY,MAAM,eAAe,YAAY,OAAO,IAAI;gBAC9D,eAAe;YACnB;QACJ;QAEA,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,SAAS;YAAM,gBAAgB;QAAY;IAE1E,EAAE,OAAO,OAAO;QACZ,QAAQ,KAAK,CAAC,cAAc;QAC5B,OAAO,gJAAY,CAAC,IAAI,CAAC;YAAE,OAAO;QAAwB,GAAG;YAAE,QAAQ;QAAI;IAC/E;AACJ"}}]
}